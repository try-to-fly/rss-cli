# RSS Run 命令改进说明

## 改进内容

### 1. 多行独立进度显示

**之前**：单行 spinner 显示，信息混在一起
```
⠋ RSS: 5/10 (+3篇) | LLM: 2篇 (1篇有趣) | 1234 tokens [15s]
```

**现在**：多行独立显示，清晰展示各阶段进度
```
⟳ RSS 抓取: [████████████░░░░░░░░] 12/20 (+5篇新文章)
⟳ 正文解析: [██████░░░░░░░░░░░░░░] 6/20
⟳ LLM 分析: [███░░░░░░░░░░░░░░░░░] 3/20 (2篇有趣) (队列:2)
  Tokens: 1,234 | 耗时: 15s
```

**特点**：
- ✅ 每个阶段独立一行
- ✅ 进度条可视化（20格）
- ✅ 状态图标（⟳ 进行中，✓ 完成）
- ✅ 实时更新（200ms 刷新）
- ✅ 失败计数（正文解析失败会显示）

### 2. 支持重复运行

**智能跳过已处理的文章**：
```typescript
function needsScraping(article: Article): boolean {
  // 如果已有正文快照且长度足够，跳过
  if (article.text_snapshot && article.text_snapshot.length > 200) {
    return false;
  }
  // 如果没有链接，无法抓取
  if (!article.link) {
    return false;
  }
  return true;
}
```

**行为**：
- ✅ 已有正文快照（>200字符）的文章会被跳过
- ✅ 正文抓取失败的文章下次运行会重试
- ✅ 未分析的文章会被自动分析
- ✅ 使用 `-f` 参数可强制重新分析所有文章

### 3. 完整的进度追踪

**追踪指标**：
- RSS 抓取：完成数/总数，新文章数
- 正文解析：完成数/总数，失败数
- LLM 分析：完成数/总数，有趣文章数，队列中的 feed 数
- Token 使用量
- 总耗时

### 4. 更清晰的完成信息

**之前**：
```
✔ 采集完成: +5篇新文章 | 分析完成: 2/20篇有趣 | 1234 tokens [30s]
```

**现在**：
```
处理完成！
✓ RSS 抓取: +5篇新文章
✓ 正文解析: 18/20篇成功
✓ LLM 分析: 2/20篇有趣
  1,234 tokens
总耗时: 30s
```

## 使用示例

### 基本使用
```bash
pnpm rss run -s -d 7
```

### 重复运行（只处理未完成的）
```bash
pnpm rss run -s -d 7
# 第二次运行会跳过已处理的文章
pnpm rss run -s -d 7
```

### 强制重新分析
```bash
pnpm rss run -s -d 7 -f
```

### 跳过某些步骤
```bash
# 只分析，不抓取新文章
pnpm rss run -s -d 7 --skip-update

# 只抓取，不分析
pnpm rss run -d 7 --skip-analyze

# 跳过正文抓取
pnpm rss run -s -d 7 --skip-scrape
```

## 技术细节

### 进度显示实现
- 使用 ANSI 转义序列控制光标移动
- `\x1b[nA`：向上移动 n 行
- `\x1b[2K`：清除当前行
- 每 200ms 刷新一次进度

### 并发控制
- RSS 抓取：5 并发
- 正文解析：2 并发（在 scraper 服务中控制）
- LLM 分析：1 并发

### 错误处理
- RSS 抓取失败：记录错误，继续处理其他 feed
- 正文解析失败：计数，不影响后续分析
- LLM 分析失败：记录日志，继续处理其他文章

## 改进效果

1. **可观察性提升**：用户可以清楚看到每个阶段的进度
2. **容错性提升**：支持重复运行，自动跳过已处理的内容
3. **用户体验提升**：进度条可视化，状态一目了然
4. **调试友好**：失败计数帮助定位问题

## 文件修改

- `src/commands/run.ts`：主要改进文件
  - 新增多行进度显示逻辑
  - 新增正文解析进度追踪
  - 改进 `needsScraping` 函数支持智能跳过
  - 优化完成信息显示
